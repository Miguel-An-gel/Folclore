<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/dash.css">
    <link rel="stylesheet" href="/css/perguntas.css">
    <link rel="stylesheet" href="/css/forca.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    #questoes {
        display: flex; 
        justify-content: space-around; 
        flex-wrap: wrap; 
        width: 100%;
    }

    #dashboard {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin: 10px;

        width: 48%;
        min-width: 400px; 
        box-sizing: border-box; 
    }


    #dashboard2 { 
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin: 10px;

        width: 48%; 
        min-width: 400px; 
        box-sizing: border-box; 
    }

    canvas {
        margin: 20px auto;
        font-family: Arial, sans-serif;
        text-align: center;
        display: block;
        box-sizing: border-box;
        max-width: 100%;
    }



.chart-container {
    width: 100%;
    margin-bottom: 25px; 
}

.chart-container h3 {
    font-size: 1.1rem;
    color: #444;
    margin-bottom: 15px;
    padding-bottom: 5px;
    border-bottom: 1px solid #eee; 
}

.custom-legend ol {
    list-style: none; 
    padding-left: 5px;
    counter-reset: list-counter; 
}

.custom-legend li {
    counter-increment: list-counter; 
    font-size: 0.95rem;
    line-height: 1.5;
    margin-bottom: 15px; 
    padding-left: 35px; 
    position: relative;
}


.custom-legend li::before {
    content: counter(list-counter); 
    position: absolute;
    left: 0;
    top: 0;
    
    font-weight: bold;
    font-size: 0.9rem;
    width: 24px;
    height: 24px;
    line-height: 24px; /* Centraliza o número verticalmente */
    text-align: center;
    border-radius: 50%;
    color: white;
}

/* Cor dos números */
#correct-legend li::before {
    background-color: #28a745; 
}

#incorrect-legend li::before {
    background-color: #dc3545; 
}
</style>
</head>

<body>
    <header>
        <nav>
            <div class="logo">
                <a href="../index.html">
                    <img src="assets/imagens/logo.png" alt="Logo Dança com cores">
                </a>
            </div>

            <div class="danca" id="danca-icon">
                <button onclick="logout()"><a>Sair</a></button>
            </div>
        </nav>
    </header>

    <div class="dashboard">
        <div id="user-info" class="sidebar">
            <img src="assets/imagens/perfil/perfil.png" alt="">
            <h2>Seja Bem-Vindo! <p><strong><span id="user-name"></span></strong> </p>
            </h2> <br>
            <p hidden><strong>Email:</strong> <span id="user-email"></span></p>
            <p hidden><strong>ID do Usuário:</strong> <span id="user_id"></span></p>
            <p><strong>Sua dança é : <span id="user-suadanca"></span></strong></p>



            <br>
            <div class="opcao">

                <br>
                <a href="dashboard.html"><button>JOGUE</button> </a><br> <br>

                <a href="dahsstatiticas.html"><button>GRAFICO</button> </a>

            </div>



        </div>

        <div class="main-content">

            <div id="questoes">



                <div id="dashboard">
                    <h1>SEU GRAFICO</h1>
                    <div>
                        <canvas id="correctIncorrectChart"></canvas>
                    </div>
                    <div>
                        <canvas id="averageTimeChart"></canvas>
                    </div>
                </div>
                <div id="dashboard2">
    <h1>ANÁLISE GERAL</h1>

    <div class="chart-container">
        <h3>Top 3 Perguntas Mais Acertadas</h3>
        <canvas id="mostCorrectChart"></canvas>
        <div id="correct-legend" class="custom-legend"></div>
    </div>

    <div class="chart-container">
        <h3>Top 3 Perguntas Mais Erradas</h3>
        <canvas id="mostIncorrectChart"></canvas>
        <div id="incorrect-legend" class="custom-legend"></div>
    </div>

</div>

            </div>
        </div>
    </div>


    <script>
    
        function logout() {
            localStorage.removeItem('usuario');
            window.location.href = '/login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {

            const usuario = JSON.parse(localStorage.getItem('usuario'));

            if (!usuario) {
                alert('Você precisa fazer login!');
                window.location.href = '/login.html'; 
                return; // Para a execução
            }

            document.getElementById('user_id').textContent = usuario.idusuario;
            document.getElementById('user-name').textContent = usuario.nome;
            document.getElementById('user-email').textContent = usuario.email;

            const idDoUsuario = usuario.idusuario;

            fetch(`/minhasDancas/${idDoUsuario}`)
                .then(response => response.json())
                .then(dancas => {
                    const suadancaElem = document.getElementById('user-suadanca');
                    if (dancas.length > 0) {
                        suadancaElem.textContent = dancas.map(danca => danca.nomedanca).join(', ');
                    } else {
                        suadancaElem.textContent = 'Você não tem danças salvas.';
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar as danças:', error);
                });

            const salvarDancaBtn = document.getElementById('salvarDancaBtn');
            if (salvarDancaBtn) {
                salvarDancaBtn.addEventListener('click', function () {
                    const dancaEscolhida = document.getElementById('dancaEscolhida').textContent;

                    fetch('/salvarDanca', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            nomedanca: dancaEscolhida,
                            fkusuario: idDoUsuario
                        })
                    })
                    .then(response => response.text())
                    .then(data => {
                        alert(data); 
                        var botao = salvarDancaBtn
                        botao.hidden = true
                        fetch(`/minhasDancas/${idDoUsuario}`)
                            .then(response => response.json())
                            .then(dancas => {
                                const suadancaElem = document.getElementById('user-suadanca');
                                if (dancas.length > 0) {
                                    suadancaElem.textContent = dancas.map(danca => danca.nomedanca).join(', ');
                                } else {
                                    suadancaElem.textContent = 'Você não tem danças salvas.';
                                }
                            })
                            .catch(error => {
                                console.error('Erro ao atualizar as danças:', error);
                            });
                    })
                    .catch(error => {
                        console.error('Erro ao salvar a dança:', error);
                    });
                });
            }


            // GRÁFICOS PESSOAIS
            fetch(`http://localhost:3010/respostas-usuario/${idDoUsuario}`)
                .then((response) => response.json())
                .then((data) => {
                    
                    console.log("DADOS DO USUÁRIO:", data);

                    if (!data || data.length === 0) {
                        const dashboardPessoal = document.getElementById("dashboard");
                        dashboardPessoal.innerHTML = "<h1>SEU GRAFICO</h1><p>Você ainda não tem estatísticas. Jogue o quiz para ver seus dados aqui!</p>";
                        return; 
                    }

                    const correctIncorrectData = {
                        correct: 0,
                        incorrect: 0
                    };
                    const times = [];

                    data.forEach((item) => {
                        if (item.acertou) {
                            correctIncorrectData.correct++;
                        } else {
                            correctIncorrectData.incorrect++;
                        }
                        times.push(parseFloat(item.tempo_resposta));
                    });

                    const averageTime = times.reduce((a, b) => a + b, 0) / times.length;

                    new Chart(document.getElementById("correctIncorrectChart"), {
                        type: "pie",
                        data: {
                            labels: ["Corretas", "Incorretas"],
                            datasets: [{
                                data: [correctIncorrectData.correct, correctIncorrectData.incorrect],
                                backgroundColor: ["#28a745", "#dc3545"],
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Sua Distribuição de Respostas',
                                    font: { size: 18 },
                                    color: '#333'
                                }
                            }
                        }
                    });

                    new Chart(document.getElementById("averageTimeChart"), {
                        type: "bar",
                        data: {
                            labels: ["Tempo Médio de Resposta"],
                            datasets: [{
                                label: 'Segundos',
                                data: [averageTime],
                                backgroundColor: ["#007bff"],
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Seu Tempo Médio de Resposta',
                                    font: { size: 18 },
                                    color: '#333'
                                }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                })
                .catch((error) => console.error("Erro ao buscar dados do usuário:", error));

//  GRÁFICOS GLOBAIS 
            fetch("http://localhost:3010/respostas-usuarios")
                .then((response) => response.json())
                .then((data) => {

                    console.log("DADOS GERAIS:", data);

                    if (!data || data.length === 0) {
                        const dashboardGeral = document.getElementById("dashboard2");
                        dashboardGeral.innerHTML = "<h1>GRAFICO GERAL</h1><p>Ainda não há dados de nenhum jogador.</p>";
                        return;
                    }

                    const questionStats = {};
                    data.forEach((item) => {
                        if (!questionStats[item.pergunta]) {
                            questionStats[item.pergunta] = { correct: 0, incorrect: 0 };
                        }
                        if (item.acertou) {
                            questionStats[item.pergunta].correct++;
                        } else {
                            questionStats[item.pergunta].incorrect++;
                        }
                    });

        
                    const top3Correct = Object.entries(questionStats)
                        .sort((a, b) => b[1].correct - a[1].correct)
                        .slice(0, 3);

                    const top3Incorrect = Object.entries(questionStats)
                        .sort((a, b) => b[1].incorrect - a[1].incorrect)
                        .slice(0, 3);

                    document.getElementById("mostCorrectChart").style.display = 'none';
                    document.getElementById("mostIncorrectChart").style.display = 'none';

                    const correctLegend = document.getElementById("correct-legend");
                    let correctLegendHTML = '<ol>'; 
                    top3Correct.forEach((item, index) => {
                        correctLegendHTML += `
                            <li>
                                ${item[0]} <strong>(${item[1].correct} acertos)</strong>
                            </li>`;
                    });
                    correctLegendHTML += '</ol>';
                    correctLegend.innerHTML = correctLegendHTML;


                    const incorrectLegend = document.getElementById("incorrect-legend");
                    let incorrectLegendHTML = '<ol>'; 
                    top3Incorrect.forEach((item, index) => {
                        incorrectLegendHTML += `
                            <li>
                                ${item[0]} <strong>(${item[1].incorrect} erros)</strong>
                            </li>`;
                    });
                    incorrectLegendHTML += '</ol>';
                    incorrectLegend.innerHTML = incorrectLegendHTML;

                })
                .catch((error) => console.error("Erro ao buscar dados gerais:", error));
        }); 
    </script>
</body>

</html>